%% get metadata
fpath = uigetfile('*.yml');
metadata = ReadYaml(fpath);
fields_list = fields(metadata);

field_map = ReadYaml('matnwb_map.yml');
field_handles = containers.Map;

% populate field_handles

needed_fields==[
    [field_map.NWBFile] [field_map.Subject]
    [field_map.ImagingPlane] [field_map.OpticalChannel]
    [field_map.PlaneSegmentation], field_map.Device
    ]

for i = 1:length(fields_list)
    if ~field_handles.isKey(fields_list{i})
        keyboard
    end
    h = field_handles(fields_list{i});
    value = metadata.(fields_list{i});
    if isa(value, 'DateTime')
        value = datestr(value);
    elseif isa(value, 'cell')
        value = strjoin(value, ';');
    end
    try
        h.Value = string(value);
    catch
        keyboard
    end
end

%% testscript
data_path='D:\Downloads\2014_04_01_p203_m19_check01_cnmfeAnalysis.mat';
fpath = uiputfile('*.nwb');
metadata = construct_metadata_struct(field_handles);
[image_masks, roi_response_data] = extract_nwb_data_cnmfe(data_path);
nwb = init_nwb_session(metadata);
nwb = add_processed_ophys(nwb, metadata, image_masks, roi_response_data);
nwbExport(nwb, fpath);

function metadata = construct_metadata_struct(field_handles)
metadata = struct;
keys = field_handles.keys;
for i = 1:length(keys)
    key = keys{i};
    handle = field_handles(key);
    value = handle.Value;
    if any(strcmp(key, {'keywords','experimenter'})) && ...
            contains(value, ';')
        value = strsplit(value, ';');
    elseif strcmp(key, {'sesssion_start_time', 'date_of_birth'})
        value = datenum(value);
    elseif isfinite(str2double(value))
        value = str2double(value);
    end
    metadata.(key) = value;
end

end
